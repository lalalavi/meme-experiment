{{ block content }}

{% block app_styles %}
    <link href="{% static 'global/css/VT_functionality.css' %}" rel="stylesheet">
    <link href="{% static 'global/css/SplitScreen.css' %}" rel="stylesheet">
    <link href="{% static 'global/css/FriendlyChecks.css' %}" rel="stylesheet">
    <link href="https://unpkg.com/nes.css/css/nes.css" rel="stylesheet" />

    <style>
        .vertical_line {
            border-left: 5px solid black;
            height: 100vh;
            position: fixed;
            left: 50%;
            z-index: 11;
        }
    </style>

{% endblock %}

<script src="https://code.jquery.com/jquery-1.10.2.js"></script>    <!-- have to keep the jquery here otherwise countdown stops working -->
<script src="https://code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
<script src="https://kit.fontawesome.com/f6dcf461c1.js" crossorigin="anonymous"></script>

<div id="hello">

    <div class="cover leftcover" id="leftcover" name="lS" style="position:absolute;">
        <!-- <br><br><p style="color: black;">Scroll down to see more memes or press button below post. </p> -->
        <br>
        <div class="nes-container" style=background-color:white;>
            <p style=color:black;background-color:white;font-family:courier;font-weight:100;>Scroll down to see more or press button to post.</p>
        </div>
        <br><br>
        {% for meme in url_list %}
        <div class="polaroid" id="polaroid-{% forloop.counter0 %}" >
            <img src= "{% static meme %}"/> 
            <br>
            <button type="button" class="btn" onclick="animateButtons(this.id)" id="dislike-{% forloop.counter0 %}"> <i class="fa fa-thumbs-down"></i></button>            
            <button type="button" class="btn" onclick="animateButtons(this.id)" id="like-{% forloop.counter0 %}"><i class="fas fa-heart"></i></button>
        </div> 
        {% endfor %} 
    </div>

    <div class="vertical_line" id="line"></div>

    <div class="cover rightcover" id="rightcover" name="rS" onmouseenter="mouselog(event)" onmouseleave="mouselog(event)">

    {{ if subsession.round_number == 1 }} 
    <br>    <div class="nes-container" style=background-color:white;visibility:visible; >
        <p style=color:black;background-color:white;font-family:courier;font-weight:100;>Your history will be displayed here once you post.</p>
    </div>
    {{ endif }}

    {{ if subsession.round_number > 1 }} 
        <br>   <div class="nes-container" style=background-color:white;visibility:visible; >
            <p style=color:black;background-color:white;font-family:courier;font-weight:100;> Your last post.    ᕕ(ᐛ)ᕗ  </p>
        </div>
        <br> <br><br> <br> <img style="width: 250px; position: fixed; margin-top: 125px; " src="{{ static image_path }}"/>
        <br><br><br><br><br> <br><br><br><br> <br>
        <!-- <br> <br> <br><br><br>  -->
    
        <button type="button" class="game-btn btn-outcome r0 c0" id="btnL" onmouseenter="recordButtons(event,this.id)" onmouseleave="recordButtons(event,this.id)"> 
            <div class="btn-content"> {{ likes }} <span style="font-size:120%; font-family:Garamond; color:red;">&hearts;</span> <br> people out of 40 <br> liked your post </div>
            <div class="btn-hidden">  </div>
        </button> 
        <div class="break"> </div>
        <button type="button" class="game-btn btn-outcome r1 c0" id="btnD" onmouseenter="recordButtons(event,this.id)" onmouseleave="recordButtons(event,this.id)">
            <div class="btn-content"> {{ dislikes }} <span style="font-size:100%; color:rgb(128, 18, 18);">&#128148;</span> <br> people out of 40 <br> <b>did not</b> like <br> your post</div>
            <div class="btn-hidden">  </div>
        </button>      
    {{ endif }}

    </div>

    <div class="post-container active">
        <button class="button_slide slide_right" id="post" style="align-self: center;" onclick="endTrial()">take me to post   ᕕ(ᐛ)ᕗ</button>   
    </div>

</div>

{% block app_scripts %}

<script src="{% static 'global/js/VT_functionality.js' %}"></script> 
<script src="{% static 'global/js/FriendlyChecks.js' %}"></script> 


<script>   
const bRequireFS    = js_vars.bRequireFS;
const bCheckFocus   = js_vars.bCheckFocus;
const defaultPixel  = js_vars.dPixelRatio;
var TBlur           = new Date().getTime();
var TFocus          = new Date().getTime();

// LOCAL COUNTERS
var Lcounter = 0;  
var Dcounter = 0;
var mouseenterTime = 0;
var mouseenterTimeFeedback = 0;

var fixations = [];
var fixationsFeedback = [];
var order = [];
var orderFeedback = [];
var last = 'x';
var TStart       = new Date().getTime();
var TEnd         = new Date().getTime();

// HIDDEN INPUT
let iFeedLikes        = document.createElement("input");
iFeedLikes.type       = 'hidden';
iFeedLikes.name       = 'iFeedLikes';
iFeedLikes.id         = 'iFeedLikes';
iFeedLikes.value      = '';

let iFeedDislikes        = document.createElement("input");
iFeedDislikes.type       = 'hidden';
iFeedDislikes.name       = 'iFeedDislikes';
iFeedDislikes.id         = 'iFeedDislikes';
iFeedDislikes.value      = '';

let sOrderFixations        = document.createElement("input");
sOrderFixations.type       = 'hidden';
sOrderFixations.name       = 'sOrderFixations';
sOrderFixations.id         = 'sOrderFixations';
sOrderFixations.value      = '';

let sFixations        = document.createElement("input");
sFixations.type       = 'hidden';
sFixations.name       = 'sFixations';
sFixations.id         = 'sFixations';
sFixations.value      = '';

let sScreenFeedback        = document.createElement("input");
sScreenFeedback.type       = 'hidden';
sScreenFeedback.name       = 'sScreenFeedback';
sScreenFeedback.id         = 'sScreenFeedback';
sScreenFeedback.value      = '';

let sScreenTimeFeedback   = document.createElement("input");
sScreenTimeFeedback.type  = 'hidden';
sScreenTimeFeedback.name  = 'sScreenTimeFeedback';
sScreenTimeFeedback.id    = 'sScreenTimeFeedback';
sScreenTimeFeedback.value = '';

let dRT          = document.createElement("input");
dRT.type         = 'hidden';
dRT.name         = 'dRTLatency';
dRT.id           = 'dRTLatency';
dRT.value        = '';



// JS INFO
treatment = js_vars.treatment;
round_number = js_vars.round_number;


function recordButtons(event,string) {
  let currentTime = new Date();
  if (event.type === 'mouseenter') {
        mouseenterTimeFeedback = currentTime.getTime();
        console.log('mouseenterTime in '+ string+ ' was:' + mouseenterTimeFeedback);
    } else if (event.type === 'mouseleave') {
        var mouseoverTimeFeedback = currentTime.getTime() - mouseenterTimeFeedback;
        console.log('mouseover time was: ' + mouseoverTimeFeedback);
        fixationsFeedback = fixationsFeedback + ';' + mouseoverTimeFeedback;
        orderFeedback = orderFeedback + ';' + string;
        console.log(fixationsFeedback, orderFeedback);
    } 
}

function animateButtons(id) {
    lSplit = id.split("-");
    idName = lSplit[0]; 
    idNr = lSplit[1];
    console.log(id);
    let likebtn = document.getElementById("like-"+idNr);  //let only creates variable in the context of the variable
    let dislikebtn = document.getElementById("dislike-"+idNr);
    if (idName == "like") {
        if (likebtn.classList.contains("active")) { 
            likebtn.classList.remove("active") ;
            Lcounter+=-1 ;
        } else if (dislikebtn.classList.contains("active")) { 
            dislikebtn.classList.remove("active") ;
            likebtn.classList.add("active") ;
            Dcounter+=-1 ;
            Lcounter++ ;
        } else { 
            likebtn.classList.add("active") ;
            Lcounter++ ;
        } 
    } else {  
        if (dislikebtn.classList.contains("active")) { 
            dislikebtn.classList.remove("active") ;
            Dcounter+=-1 ;
        } else if (likebtn.classList.contains("active")) { 
            likebtn.classList.remove("active") ;
            dislikebtn.classList.add("active") ;
            Lcounter+=-1 ;
            Dcounter++ ;
        } else { 
            dislikebtn.classList.add("active") ;
            Dcounter++ ;
        } 
    }
    console.log(Lcounter, Dcounter);
}

function mouselog(event) {
    let currentTime = new Date();
    let left = document.getElementById('leftcover');
    let right = document.getElementById('rightcover');
    const results = left.getBoundingClientRect();    // returns DOMRect OBJECT with bottom, height, left, right, top, width (!!!!!), x, y of ELEMENT
    let widthLeft = results.width; 

    if (event.type === 'mouseenter' && last === 'x') {     // entering right for the first time
            mouseenterTime = currentTime.getTime();
            console.log('FIRST enter time in rS was:' + mouseenterTime);
            last = 'rS';
        } else if (event.type === 'mouseenter' && last === 'lS') {     // entering right after being left
            var mouseoverTime = currentTime.getTime() - mouseenterTime;
            console.log('mouseover time in left screen time was: ' + mouseoverTime);
            fixations = fixations + ';' + mouseoverTime;
            order = order + ';' + last;
            console.log(fixations, order);
            mouseenterTime = currentTime.getTime();
            console.log('mouseenterTime in rS was:' + mouseenterTime);
            last = 'rS';
        } else if (event.type === 'mouseleave') { 
            var mouseoverTime = currentTime.getTime() - mouseenterTime;
            console.log('mouseover time in right screen was: ' + mouseoverTime);
            fixations = fixations + ';' + mouseoverTime;
            last = 'rS'; 
            order = order + ';' + last;
            console.log(fixations, order); 
        } 
    if (last === 'x' && event.clientX < widthLeft) {
            mouseenterTime = currentTime.getTime();
            console.log('FIRST enter time in lS was:' + mouseenterTime);   
            last = 'lS';
        } else if (last === 'rS' && event.clientX < widthLeft) {
            mouseenterTime = currentTime.getTime();
            console.log('mouseenterTime in lS was:' + mouseenterTime);   
            last = 'lS';
     }
}

 // END FUNCTION: LOCAL COUNTERS WRITTEN IN THE DATABASE
 function endTrial() {
    TEnd = new Date().getTime();
    dRT.value = +TEnd -TStart; 
    // console.log(dRT.value);
    iFeedLikes.value = Lcounter ; 
    iFeedDislikes.value = Dcounter ;
    sFixations.value = fixations ;
    sOrderFixations.value = order ; 
    sScreenFeedback.value = orderFeedback ; 
    sScreenTimeFeedback.value = fixationsFeedback ; 
    console.log('Post button was pressed');
};
  
document.addEventListener("DOMContentLoaded", function(debug=false) {
    console.log('Loading info');
    console.log(treatment);

    let hidestuff = document.getElementsByClassName("card debug-info")[0];
    hidestuff.style.visibility = 'hidden';   // this hides the debug information so i do not go crazy 

    let body = document.getElementById('rightcover');
    let fullbody = document.getElementById('hello');

    InitializeFriendlyChecks(fullbody, bRequireFS, bCheckFocus);
    InitializeVT(body);                                                 // Initialize visual tracing
    // InitializeVT(body,sNameButtonClicks='sButtonClickScreen', sNameTimeClicks='sTimeClickScreen');                                                 // Initialize visual tracing
    hideEverything();                                                   // Hide Everything at the beginning                     
    ConvertButtons2VT('r0', sActivation = 'mouseover', 'r0');           // Mouseover for Row0
    ConvertButtons2VT('r1', sActivation = 'mouseover', 'r1');           // Mouseover for Row1
	resizeButtons();                                                    // Resize the text of all overflown buttons
    
	function resizeButtons() {
        lButtons = document.getElementsByClassName('game-btn');
    for (let i=0; i<lButtons.length; i++) {
        adjustText(lButtons[i]);
        };
    };

	function adjustText(elem) {
    let ratioWidth = elem.clientWidth/elem.scrollWidth;
    let ratioHeight = elem.clientHeight/elem.scrollHeight;
    // Set initial scale as 100%
    if (ratioWidth<1 || ratioHeight<1) {
        let ratio = Math.floor(100*Math.min(ratioWidth,ratioHeight))-1
        elem.style.fontSize = `${ratio}%`;
        console.log(`Resized ${elem.id} to ${ratio}%`);
        };                                  
    };

    if (js_vars.round_number > 1) {
        let x = document.getElementById('btnD');
        let c = document.getElementById('btnL');
        if (js_vars.treatment=='Control') {
            x.style.visibility = 'hidden';  //for control treatment we don't show amount of dislikes
        } else if (js_vars.treatment=='Emotional') { 
            c.style.visibility = 'hidden';  //for emotional treatment we don't show the amount of likes
        } else {
            x.style.visibility = 'visible';
            c.style.visibility = 'visible';
	}};

    function mousePosition(event) {
        let left = document.getElementById('leftcover');
        let right = document.getElementById('rightcover');
        const results = left.getBoundingClientRect();    // returns DOMRect OBJECT with bottom, height, left, right, top, width (!!!!!), x, y of ELEMENT
        let widthLeft = results.width;                   // we access the with only
        if (event.clientX > widthLeft) {
            left.style.zIndex = "1";
            left.style.visibility = "hidden";
            right.style.zIndex = "10";
            right.style.display = "flex";

        } else {
            left.style.zIndex = "10";
            left.style.visibility = "visible";
            right.style.zIndex = "1";
            right.style.display = "none";
    }}

    window.addEventListener('mousemove', mousePosition);

    let OtreeBody     = document.getElementsByClassName("_otree-content")[0];
    OtreeBody.appendChild(iFeedLikes);
    OtreeBody.appendChild(iFeedDislikes);
    OtreeBody.appendChild(sScreenTimeFeedback);
	OtreeBody.appendChild(sScreenFeedback);
    OtreeBody.appendChild(sFixations);
    OtreeBody.appendChild(sOrderFixations);
    OtreeBody.appendChild(dRT);
});

</script>

{% endblock %}

{{ endblock }}